<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<title>파킹메이트 매칭</title>
<th:block th:include="@{/header}"></th:block>
<style>

</style>
</head>
<body>
<header><h1>파킹메이트 매칭</h1></header>
	<p th:text="'총 ' + ${instadList.size()} + '건의 예약 요청이 있습니다.'"></p>
	<table>
		<thead>
			<tr>
				<th>예약번호</th>
				<th>예약일자</th>
				<th>차량번호</th>
				<th>입차시간</th>
				<th>출차시간</th>
				<th>주차장</th>
				<th>주차장 위치</th>
				<th>요금</th>
				<th>사용자 위치</th>
				<th>파킹메이트 위치</th>
				<th>처리</th>
			</tr>
		</thead>
		<tbody>
			<tr th:each="item : ${instadList}">
				<td th:text="${item.bookingnum}"></td>
				<td th:text="${item.bookingdate?.format(T(java.time.format.DateTimeFormatter).ofPattern('yyyy-MM-dd HH:mm'))}"></td>
				<td th:text="${item.bookingcarnum}"></td>
				<td th:text="${item.intime?.format(T(java.time.format.DateTimeFormatter).ofPattern('yyyy-MM-dd HH:mm'))}"></td>
				<td th:text="${item.outtime?.format(T(java.time.format.DateTimeFormatter).ofPattern('yyyy-MM-dd HH:mm'))}"></td>
				<td th:text="${item.lotName}"></td>
				<td th:text="${item.lotAddr}"></td>
				<td th:text="${item.lotPrice}"></td>
				<td th:text="|(${item.ulatitude}, ${item.ulongitude})|"></td>
				<td th:text="|(${item.pmlatitude}, ${item.pmlongitude})|"></td>
				<td>
					<form th:action="@{/pm/matching/accept}" method="post" th:attr="data-waiting-count=${waitingCount}" onsubmit="return checkSettlement(this);" style="display:inline;">
    				<input type="hidden" name="bookingnum" th:value="${item.bookingnum}" />
    				<input type="submit" value="수락" />
					</form>
					<form th:action="@{/pm/matching/reject}" method="post" style="display: inline;">
						<input type="hidden" name="bookingnum" th:value="${item.bookingnum}" /> 
						<input type="submit" value="거절" />
					</form>
				</td>
			</tr>
		</tbody>
	</table>
<p><a th:href="@{/parkingmate}">파킹메이트 메인</a></p>
<th:block th:include="@{/footer}"></th:block>
<script>
function checkSettlement(form) {
    const waitingCount = parseInt(form.getAttribute("data-waiting-count"));
    if (waitingCount >= 2) {
        alert("정산대기 상태의 예약이 2건 이상 있어 수락할 수 없습니다. 먼저 정산을 완료해주세요.");
        return false; 
    }
    return true;
}
</script>
</body>
</html>