<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>파킹메이트 이용현황</title>
<th:block th:include="@{/header}"></th:block>
<!-- ✅ 카카오 지도 SDK -->
<script
	src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=bef1fdbfb5b4d0c4519859a35fd0e1c4&autoload=false"></script>

<style>
body {
	font-family: 'Segoe UI', '맑은 고딕', sans-serif;
	background-color: #f5f7fa;
	color: #2c3e50;
	margin: 0;
	padding: 40px 20px;
}

h1 {
	font-size: 28px;
	margin-bottom: 30px;
	border-left: 5px solid #B1B2FF;
	padding-left: 15px;
	color: #1a1a1a;
}

#map {
	width: 100%;
	height: 400px;
	border: 1px solid #ccc;
	border-radius: 10px;
	margin-bottom: 20px;
}

#route-info {
	font-size: 16px;
	color: #333;
	margin-bottom: 30px;
}

a {
	display: inline-block;
	margin-top: 10px;
	color: #6C72FF;
	text-decoration: none;
	font-weight: 600;
	transition: color 0.3s ease;
}

a:hover {
	color: #555bff;
}

@media ( max-width : 600px) {
	#map {
		height: 300px;
	}
}

.customInfoBox {
	background: white;
	border: 2px solid #4A90E2;
	border-radius: 8px;
	padding: 10px 15px;
	font-size: 14px;
	color: #333;
	box-shadow: 0 2px 6px rgba(74, 144, 226, 0.3);
	white-space: nowrap;
}

.customInfoBox b {
	color: #4A90E2;
}
</style>
</head>

<script th:inline="javascript">
  /*<![CDATA[*/
  const usageList = /*[[${usageList}]]*/ [];
  if (usageList.length === 0) {
    alert('예약 내역이 없습니다.');
    history.back();
  }
  /*]]>*/
</script>

<body>
	<h1>파킹메이트 이용현황</h1>
	<div id="map"></div>
	<div id="route-info"></div>
	<!-- 경로 정보 표시 영역 -->

	<script>
	
  kakao.maps.load(function () {
      if (usageList.length === 0) return;
      
      const endPos = new kakao.maps.LatLng(usageList[0].ulatitude, usageList[0].ulongitude);
      function getTimeHTML(distance) {
      	const walkMinTotal = Math.floor(distance / 67);
      	  const walkHour = Math.floor(walkMinTotal / 60);
      	  const walkMin = walkMinTotal % 60;

      	  const bikeMinTotal = Math.floor(distance / 227);
      	  const bikeHour = Math.floor(bikeMinTotal / 60);
      	  const bikeMin = bikeMinTotal % 60;

      	  const walkTimeStr =
      	    (walkHour > 0 ? `${walkHour}시간 ` : '') +
      	    (walkMin > 0 ? `${walkMin}분` : (walkHour === 0 ? '0분' : ''));

      	  const bikeTimeStr =
      	    (bikeHour > 0 ? `${bikeHour}시간 ` : '') +
      	    (bikeMin > 0 ? `${bikeMin}분` : (bikeHour === 0 ? '0분' : ''));

      	  return `
      	    <div class="customInfoBox">
      	      <b>총 거리:</b> ${distance} m<br>
      	      <b>도보 시간:</b> ${walkTimeStr}<br>
      	      <b>자전거 시간:</b> ${bikeTimeStr}
      	    </div>
      	  `;
      	  }

      // 지도와 마커 그리는 로직을 함수로 분리
      function drawMap(startPos) {
        const mapContainer = document.getElementById('map');
        const map = new kakao.maps.Map(mapContainer, { center: startPos, level: 5 });

        const movingMarkerImage = new kakao.maps.MarkerImage(
        		  'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/red_b.png',
        		  new kakao.maps.Size(50, 50)
        		);

        		const carPosMarkerImage = new kakao.maps.MarkerImage(
        		  'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/blue_b.png',
        		  new kakao.maps.Size(50, 50)
        		);
        	  
        	  const movingPos = startPos;
        	  const carPos = new kakao.maps.LatLng(usageList[0].ulatitude, usageList[0].ulongitude); // 차량 위치


        	  // 마커 찍기
        	  new kakao.maps.Marker({
        	    map,
        	    position: movingPos,
        	    image: movingMarkerImage,
        	    title: '출발지'
        	  });

        	  new kakao.maps.Marker({
        		  map: map,
        		  position: carPos,
        		  image: carPosMarkerImage,
        		  title: '도착지'
        		});

        	  // 경로 선
        	  const routePath = [movingPos, carPos];
        	  const polyline = new kakao.maps.Polyline({
        	    path: routePath,
        	    strokeWeight: 5,
        	    strokeColor: '#4A90E2',
        	    strokeOpacity: 0.7,
        	    strokeStyle: 'solid'
        	  });
        	  polyline.setMap(map);

        	  const distance = Math.round(polyline.getLength());
        	  const content = getTimeHTML(distance);
        	  new kakao.maps.CustomOverlay({
        	    map,
        	    position: movingPos,
        	    content: content,
        	    xAnchor: 0.5,
        	    yAnchor: 1.8,
        	    zIndex: 3
        	  });

        	  // 하단 정보
        	  const routeInfoDiv = document.getElementById('route-info');
        	  routeInfoDiv.innerHTML = `
        	    <b>출발지:</b> 위도 ${movingPos.getLat().toFixed(6)}, 경도 ${movingPos.getLng().toFixed(6)}<br>
        	    <b>차량 위치:</b> 위도 ${carPos.getLat().toFixed(6)}, 경도 ${carPos.getLng().toFixed(6)}<br>
        	  `;
      }

   		// 위치 권한 요청
	    if (navigator.geolocation) {
	      navigator.geolocation.getCurrentPosition(
	        (position) => {
	          const gpsPos = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
	          drawMap(gpsPos);
	        },
	        (error) => {
	          const dbPos = new kakao.maps.LatLng(usageList[0].pmlatitude, usageList[0].pmlongitude);
	          drawMap(dbPos);
	        }
	      );
	    } else {
	      const dbPos = new kakao.maps.LatLng(usageList[0].pmlatitude, usageList[0].pmlongitude);
	      drawMap(dbPos);
	    }
});
  
  </script>
  	<h2><a th:href="@{/parking}">차를 받으셨나요?</a></h2>
	<a th:href="@{/parkingmate}">파킹메이트 메인</a>
	<th:block th:include="@{/footer}"></th:block>
</body>
</html>
