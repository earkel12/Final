<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ParkingMate 메인</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=bef1fdbfb5b4d0c4519859a35fd0e1c4&autoload=false&libraries=services"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #F5F8FF;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h2 {
      text-align: center;
      color: #4B55E1;
      margin-bottom: 20px;
    }
    #map {
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 15px;
    }
    button {
      display: block;
      margin: 20px auto;
      background-color: #4B55E1;
      color: white;
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
    }
    em {
      display: block;
      text-align: center;
      color: #666;
      margin-top: 10px;
    }
  </style>
</head>
<body>
<h2>약속장소 등록하기</h2>
<div id="map" style="width:100%; height:500px;"></div>
<p><em id="addressDisplay">지도를 클릭해주세요!</em></p>

<!-- 입력값 저장용 -->
<input type="hidden" name="ulatitude" id="ulatitude" readonly>
<input type="hidden" name="ulongitude" id="ulongitude" readonly>
<input type="hidden" name="roadAddress" id="roadAddress" readonly>

<button onclick="sendLocation()">등록하기</button>

<script>
  kakao.maps.load(function () {
    const mapContainer = document.getElementById('map');
    const mapOption = {
      center: new kakao.maps.LatLng(37.5665, 126.9780),
      level: 5
    };

    const map = new kakao.maps.Map(mapContainer, mapOption);
    const marker = new kakao.maps.Marker({
      position: map.getCenter()
    });
    marker.setMap(map);

    const geocoder = new kakao.maps.services.Geocoder();

    kakao.maps.event.addListener(map, 'click', function (mouseEvent) {
      const latlng = mouseEvent.latLng;
      marker.setPosition(latlng);

      const lat = latlng.getLat();
      const lng = latlng.getLng();

      document.getElementById('ulatitude').value = lat;
      document.getElementById('ulongitude').value = lng;

      // 좌표 → 주소 변환
      geocoder.coord2Address(lng, lat, function (result, status) {
        if (status === kakao.maps.services.Status.OK) {
          const roadAddr = result[0].road_address?.address_name || "도로명 주소 없음";
          document.getElementById('roadAddress').value = roadAddr;
          document.getElementById('addressDisplay').innerText = "도로명 주소: " + roadAddr;
        }
      });
    });
  });

  function sendLocation() {
    const lat = document.getElementById('ulatitude').value;
    const lng = document.getElementById('ulongitude').value;
    const roadAddr = document.getElementById('roadAddress').value;

    if (window.opener && !window.opener.closed) {
      window.opener.document.getElementById('ulatitude').value = lat;
      window.opener.document.getElementById('ulongitude').value = lng;
      window.opener.document.getElementById('roadAddress').value = roadAddr;
      window.opener.document.getElementById('locationBtn').innerText = "약속장소 등록완료";
      window.close();
    } else {
      alert("잘못된 경로입니다.");
    }
  }
</script>
</body>
</html>
