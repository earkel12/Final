<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>주차장 예약하기</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .container { max-width: 800px; margin: auto; }
    .section-title { font-size: 1.2em; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    td, th { padding: 10px; vertical-align: top; }
    .input-group { margin-bottom: 10px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; }
    select, input[type="text"], input[type="number"] { width: 100%; padding: 5px; }
    .radio-group { display: flex; gap: 10px; margin-top: 5px; }
    .summary-box { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    .right-align { text-align: right; }
  </style>
</head>
<body>
<th:block th:include = "@{/header}"></th:block>
  <div class="container">

    <h2>예약하기</h2>

    <!-- 주차장 이름 표시 -->
	<p th:text="'선택한 주차장: ' + ${session.pname}"></p>
	
	<!-- 사진 -->
	<!--<img th:src="@{'/images/' + ${session.pIdx} + '.jpg'}" alt="주차장 사진" width="100%">-->
	
	<!-- 가격 -->
	<p>기본 이용 금액 : <span id="basePrice" th:text="${session.price}">0</span>원</p>
	<p>30분당 이용 금액 : <span id="per30min" th:text="${session.price2}">0</span>원</p>

    <!-- 2. 예약 정보 입력 영역 -->
    <form action="/booking/agree" method="post" onsubmit="return checkLocation()">
      <select id="bookingcarnum" name="bookingcarnum">
		  <option value="">-- 선택 --</option>
		  <option th:each="car : ${carList}"
		          th:value="${car.car_num}"
		          th:text="${car.car_num + ' / ' + car.modelname}">차량명</option>
		</select>

      <div class="input-group">
        <label for="entryTime">입차 시간 선택</label>
        <input type="datetime-local" id="inTime" name="inTime">
      </div>

      <div class="input-group">
        <label for="duration">예상 주차 시간 (시간)</label>
        <input type="number" id="duration" name="duration" min="1" placeholder="예: 2">
      </div>

      <!-- 3. 선택사항 -->
      <div class="input-group">
        <label>발렛 유무</label>
        <div class="radio-group">
          <label><input type="radio" name="valet" value="1"> 있음</label>
          <label><input type="radio" name="valet" value="0" checked> 없음</label>
        </div>
      </div>

      <div class="input-group">
        <label>파킹메이트 유무</label>
        <div class="radio-group">
          <label><input type="radio" name="instand" value="1"> 있음</label>
          <label><input type="radio" name="instand" value="0" checked> 없음</label>
        </div>
          <!-- ✅ 현위치 등록 버튼 (기본은 숨김) -->
		 <button type="button" id="locationBtn" style="display:none; margin-top: 10px;">
		   약속장소 등록하기
		 </button>
		 <input type="hidden" name="ulatitude" id="ulatitude" value="0">
		 <input type="hidden" name="ulongitude" id="ulongitude" value="0">
      </div>

      <div class="input-group">
        <label>장애인 여부</label>
        <div class="radio-group">
          <label><input type="radio" name="obstacle" value="1"> 해당</label>
          <label><input type="radio" name="obstacle" value="0" checked> 해당 없음</label>
        </div>
      </div>
	   <div class="input-group">
        <label>예상 금액</label>
        <p id="estimate">0원</p>
      </div>

      <p style="font-size: 0.8em;">※ 주차비는 출차 시 결제됩니다</p>
	  
	  
      <!-- 4. 결제 -->
      <div class="right-align">
        <p>결제 금액 : <span id="total">0</span>원</p>
        <input type="hidden" id="totalInput" name="total" value="0">
        <button type="submit" disabled>다음</button>
      </div>

    </form>

  </div>

  <script>
	  const base = parseInt(document.getElementById("basePrice").textContent);
	  const per30 = parseInt(document.getElementById("per30min").textContent);
	  const durationInput = document.getElementById("duration");
	  const estimateDisplay = document.getElementById("estimate");
	  const totalDisplay = document.getElementById("total");
	  const instandRadios = document.getElementsByName("instand");
	  const locationBtn = document.getElementById("locationBtn");
	  const bookingCarSelect = document.getElementById("bookingcarnum");
	  const inTimeInput = document.getElementById("inTime");
	  const submitBtn = document.querySelector("form button[type='submit']");
 
	  
	  let addMateFee = 0; // 파킹메이트 추가 요금
	
	  // 총 금액 계산 함수
	  function calculateTotal() {
	    const hours = parseInt(durationInput.value);
	    if (!isNaN(hours)) {
	      const timeCost = (hours * 2) * per30;
	      const total = base + timeCost;
	      estimateDisplay.textContent = total + "원";
	      totalDisplay.textContent = base+addMateFee;
	      document.getElementById("totalInput").value = base+addMateFee;
	    }
	  }
	  
	  // 폼 입력 유효성 검사
	  function validateForm() {
	    const carSelected = bookingCarSelect.value !== "";
	    const inTimeSelected = inTimeInput.value !== "";
	    const durationValid = durationInput.value !== "" && parseInt(durationInput.value) > 0;

	    submitBtn.disabled = !(carSelected && inTimeSelected && durationValid);
	  }
	  // 각 필드 변경 시 유효성 검사
	  bookingCarSelect.addEventListener("change", validateForm);
	  inTimeInput.addEventListener("input", validateForm);
	  durationInput.addEventListener("input", function () {
	    calculateTotal();
	    validateForm();
	  });
	  
	  // 주차 시간 입력 시 계산
	  durationInput.addEventListener("input", calculateTotal);
	  
	  // 파킹메이트 선택 시 추가요금 적용
	  instandRadios.forEach(radio => {
	    radio.addEventListener("change", function () {
	      addMateFee = this.value === "1" ? 10000 : 0;
	      locationBtn.style.display = this.value === "1" ? "inline-block" : "none";
	      calculateTotal(); // 선택 변경 시 다시 계산
	    });
	  });
	  
	  // ✅ 버튼 클릭 시 팝업 열기
	  locationBtn.addEventListener("click", function () {
	    window.open(
	      "/location",
	      "locationPopup",
	      "width=600,height=600,top=100,left=200"
	    );
	  });
	  
	  // 초기 비활성화
	  submitBtn.disabled = true;
	  
	  //장소 미등록시
		  function checkLocation() {
    const instandSelected = document.querySelector('input[name="instand"]:checked').value === "1";
    const ulat = document.getElementById("ulatitude").value;

    if (instandSelected && (!ulat || ulat === "0")) {
      alert("파킹메이트를 선택한 경우, 약속 장소를 등록해야 합니다.");
      return false;  // 제출 중지
    }

    return true; // 제출 계속
  }
	</script>
 
<th:block th:include = "@{/footer}"></th:block>	
</body>
</html>
