<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>

<meta charset="UTF-8">
<title>íŒŒí‚¹ë©”ì´íŠ¸ ë§¤ì¹­ì¤‘</title>
<link rel="stylesheet" href="/css/booking/mateUsagesStatus.css">
  <!-- ë³µì¡í•œ DOM ì¡°ì‘, AJAX, ì´ë²¤íŠ¸ ì²˜ë¦¬ 
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script> -->
  <!-- ê²°ì œapi -->
  <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

<!-- Jqurryì‚¬ìš© -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Jsë³„ë„ê´€ë¦¬ -->
<script src="/js/involveMateUsageStatusList.js"></script>
<script src="/js/involveMateUsageStatus_Pay.js"></script>
<!-- ì„¸ì…˜ê´€ë¦¬ -->
<script src="/js/checkSession.js"></script>
<!--SweetAlert2  -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>
<body>
<th:block th:include = "@{/header}"></th:block>

<nav id="floatingNav">
  <ul>
    <li><a href="/">íšŒì‚¬ì†Œê°œ</a></li>
    <li><a href="search">ì˜ˆì•½í•˜ê¸°</a></li>
    <li><a href="mateUsagesStatus">ì´ìš©í˜„í™©</a></li>
    <li><a href="notice">ê³µì§€ì‚¬í•­</a></li>
    <li><a href="community">ì»¤ë®¤ë‹ˆí‹°</a></li>
    <li><a href="mypageMain">ë§ˆì´í˜ì´ì§€</a></li>
  </ul>
</nav>

<div class="container">

	<!-- ğŸš— ì°¨ëŸ‰ë²ˆí˜¸ íƒ­ ì˜ì—­ -->
	<div class="tab-container">
    <ul class="tab-list">
        <li th:each="usercarnum : ${reservedCarNums}">
           <a th:href="@{/mateUsagesStatus(bookingcarnum=${usercarnum})}"
			   th:text="${usercarnum}"
			   class="tab-item"
			   th:classappend="${usercarnum == selectedCarNum} ? 'active' : ''">
			</a>
        </li>
    </ul>
	</div>
	
    <!-- ìƒë‹¨ -->
    <div class="top-section">
    <!-- ìƒíƒœë©”ì„¸ì§€ë°•ìŠ¤ -->
    <div class="status-box">

        <!-- ì¶œì°¨ ì™„ë£Œ ìƒíƒœ (ìµœìš°ì„ ) -->
        <span th:if="${booking['intime'] != null and booking['outtime'] != null}">
            ì¶œì°¨ ì™„ë£Œ! ì´ìš©ì‹œê°„:
            <span th:text="${T(java.time.Duration).between(booking['intime'], booking['outtime']).toMinutes()}"></span>ë¶„
        </span>

        <!-- ì…ì°¨ ì™„ë£Œ ìƒíƒœ -->
        <span th:if="${booking['intime'] != null and booking['outtime'] == null}">
            ì…ì°¨ ì™„ë£Œ!
        </span>

        <!-- instand == 1 + findMate ìƒíƒœ í‘œì‹œ (ì…ì°¨/ì¶œì°¨ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ) -->
        <span th:if="${booking['intime'] == null and booking['instand'] == 1 and !#lists.isEmpty(findMate)}">
            íŒŒí‚¹ë©”ì´íŠ¸ ë§¤ì¹­ì™„ë£Œ!
        </span>

        <span th:if="${booking['intime'] == null and booking['instand'] == 1 and #lists.isEmpty(findMate)}">
            íŒŒí‚¹ë©”ì´íŠ¸ ë§¤ì¹­ ì¤‘
        </span>

        <!-- instand != 1 ìƒíƒœ í‘œì‹œ (ì…ì°¨/ì¶œì°¨ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ) -->
        <span th:if="${booking['intime'] == null and booking['instand'] != 1}"
              th:text="${#lists.isEmpty(findMate) ? 'íŒŒí‚¹ë©”ì´íŠ¸ê²°ì œì™„ë£Œ' : 'íŒŒí‚¹ë©”ì´íŠ¸ ë§¤ì¹­ì™„ë£Œ!'}">
        </span>
    </div>

		<!-- ì˜ˆì•½ì •ë³´ -->
        <div class="info-box" th:each="booking : ${bookingInfoByCarnum}">
            <div class="info-item">
                <span>ì£¼ì°¨ì¥:</span> 
                <span th:text="${parkinglotdto != null ? parkinglotdto.name : 'ì—†ìŒ'}"></span>
            </div>
            <div class="info-item">
                <span>ì…ì°¨ì‹œê°„:</span> 
                <span th:text="${intime != null ? #temporals.format(intime, 'yyyy-MM-dd HH:mm:ss') : '-'}"></span>


            </div>
            <div class="info-item">
                <span>ì¶œì°¨ì‹œê°„:</span> 
                <span id="outtime-display" th:text="${outtime != null ? #temporals.format(outtime, 'yyyy-MM-dd HH:mm:ss') : '-'}"></span>

            </div>
            <div class="info-item">
                <span>ê²°ì œê¸ˆì•¡:</span> 
                <span id="lastpay" th:text="${booking['outtime'] != null ? (#numbers.formatInteger(booking.price, 3, 'COMMA') + 'ì›') : '0ì›'}"></span>
            </div>
            
                <div class="button-group-inline">
				    <!-- ì…ì°¨í•˜ê¸° -->
				    <input type="hidden"
				        th:id="'bookingnum-' + ${booking.bookingnum}"
				        th:value="${booking.bookingnum}">
				    <button type="button"
				        th:id="'intimeBtn-' + ${booking.bookingnum}"
				        th:if="${booking['intime'] == null and booking['instand'] != 1}"
				        onclick="updateIntime(this)">ì…ì°¨í•˜ê¸°</button>
				
				    <!-- ì¶œì°¨í•˜ê¸° -->
				    <input type="hidden"
				        th:id="'bookingnum-' + ${booking.bookingnum}"
				        th:value="${booking.bookingnum}">
				    <button type="button"
				        th:id="'outtimeBtn-' + ${booking.bookingnum}"
				        th:if="${booking['intime'] != null and booking['outtime'] == null}"
				        th:attr="data-bookingnum=${booking.bookingnum}"
				        onclick="updateOuttime(this)">ì¶œì°¨í•˜ê¸°</button>
				
				    <!-- ê²°ì œí•˜ê¸° -->
				    <button type="button" id="paymentBtn">ê²°ì œí•˜ê¸°</button>
				</div>
        </div>
    </div>
	
	<!-- âœ… ì¶”ê°€: ì…ì°¨ì™„ë£Œ ìƒíƒœ JS ì „ë‹¬ -->
    <script th:inline="javascript">
        const isEntered = /*[[${booking['intime'] != null and booking['outtime'] == null}]]*/ false;
    </script>
	
    <!-- í•˜ë‹¨ -->
    <div class="bottom-section">
        <div class="map-box" id="map">
            <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=bef1fdbfb5b4d0c4519859a35fd0e1c4&autoload=false"></script>
			<script>
			kakao.maps.load(function () {
				//ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ìœ„ë„, ê²½ë„
				const lat = '[[${parkinglotdto.latitude}?:0]]';
    			const lng = '[[${parkinglotdto.longitude}?:0]]';
    			const name = '[[${parkinglotdto != null ? parkinglotdto.name : "ì—†ìŒ"}]]';
    			const addr = '[[${parkinglotdto != null ? parkinglotdto.addr : "ì—†ìŒ"}]]';
				
    			const userLat = parseFloat('[[${ulatitude}?:0]]');
    			const userLng = parseFloat('[[${ulongitude}?:0]]');

    			const mateLat = parseFloat('[[${pmlatitude}?:0]]');
    			const mateLng = parseFloat('[[${pmlongitude}?:0]]');
    			
			    const mapContainer = document.getElementById('map');
			    const mapOption = {
			        center: new kakao.maps.LatLng(lat, lng), // ì´ˆê¸° ì¤‘ì‹¬ ì¢Œí‘œ(ì„œìš¸)
			    	level: 2
			    };
			    const map = new kakao.maps.Map(mapContainer, mapOption);
			    
			 	// âœ… ì‚¬ìš©ì ë§ˆì»¤ ì´ë¯¸ì§€ URL
			    const userImageSrc = '/img/pin_man2.png';
			    const userImageSize = new kakao.maps.Size(40, 40);
			    const userImageOption = { offset: new kakao.maps.Point(20, 40) };
			    const userMarkerImage = new kakao.maps.MarkerImage(userImageSrc, userImageSize, userImageOption);

			    // âœ… ë©”ì´íŠ¸ ë§ˆì»¤ ì´ë¯¸ì§€ URL
			    const mateImageSrc = '/img/pin_manwalking.png';
			    const mateImageSize = new kakao.maps.Size(40, 40);
			    const mateImageOption = { offset: new kakao.maps.Point(20, 40) };
			    const mateMarkerImage = new kakao.maps.MarkerImage(mateImageSrc, mateImageSize, mateImageOption);

			 	// ì£¼ì°¨ì¥ ë§ˆì»¤
			    const markerPosition = new kakao.maps.LatLng(lat, lng);
			    const marker = new kakao.maps.Marker({
			        position: markerPosition,
			        map: map,
			        title: name
			    });
				
			    
			 	// ì‚¬ìš©ì/ë©”ì´íŠ¸ ë§ˆì»¤ ë° ê±°ë¦¬, ì„  í‘œì‹œ ì œì•½ ì¡°ê±´ ì ìš©
	            if (!isEntered) {
			 	// ìœ ì € ë§ˆì»¤
			    const userMarker = new kakao.maps.Marker({
			        position: new kakao.maps.LatLng(userLat, userLng),
			        image: userMarkerImage, // âœ… ì´ë¯¸ì§€ ì¶”ê°€
			        map: map,
			        title: "ì‚¬ìš©ì ìœ„ì¹˜"
			    });

			    // ë©”ì´íŠ¸ ë§ˆì»¤
			    const mateMarker = new kakao.maps.Marker({
			        position: new kakao.maps.LatLng(mateLat, mateLng),
			        image: mateMarkerImage, // âœ… ì´ë¯¸ì§€ ì¶”ê°€
			        map: map,
			        title: "íŒŒí‚¹ë©”ì´íŠ¸ ìœ„ì¹˜"
			    });
			    
			    //í•˜ë²„ì‚¬ì¸ ê³µì‹ ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜
			    function calculateDistance(lat1, lng1, lat2, lng2) {
			        const R = 6371000; // m
			        const toRad = x => x * Math.PI / 180;
			        const dLat = toRad(lat2 - lat1);
			        const dLng = toRad(lng2 - lng1);
			        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
			                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
			                  Math.sin(dLng/2) * Math.sin(dLng/2);
			        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
			        return Math.round(R * c);
			    }
				
			    const distance = calculateDistance(userLat, userLng, mateLat, mateLng);
				
			    const speed_mps = 1.1; // m/s (ë„ë³´ ê¸°ì¤€)
			    const estimatedTime_sec = distance / speed_mps;
			    const estimatedTime_min = Math.round(estimatedTime_sec / 60);
			    
			 	// ê±°ë¦¬ í‘œì‹œ
			    const distanceDiv = document.createElement('div');
			    distanceDiv.style.background = 'white';
			    distanceDiv.style.padding = '5px 10px';
			    distanceDiv.style.border = '2px solid black';
			    distanceDiv.style.borderRadius = '8px';
			    distanceDiv.style.fontSize = '14px';
			    distanceDiv.style.fontWeight = 'bold';
			   
			 	// ê±°ë¦¬ í…ìŠ¤íŠ¸ ìƒì„±
			    distanceDiv.textContent = `í˜„ì¬ ë©”ì´íŠ¸ì™€ì˜ ê±°ë¦¬: ${distance} m (ë„ë³´ ì•½ ${estimatedTime_min}ë¶„ ì†Œìš”)`;

			    // ë©”ì´íŠ¸ ì •ë³´ë°•ìŠ¤ í•˜ë‹¨ì— ì¶”ê°€
			    const mateInfoBox = document.querySelector('.mate-info-box');
			    if (mateInfoBox) {
			        distanceDiv.style.background = '#F0F1FF';
			        distanceDiv.style.padding = '10px';
			        distanceDiv.style.marginTop = '10px';
			        distanceDiv.style.border = '2px solid #B1B2FF';
			        distanceDiv.style.borderRadius = '8px';
			        distanceDiv.style.fontSize = '14px';
			        distanceDiv.style.fontWeight = 'bold';
			        distanceDiv.style.textAlign = 'center';

			        mateInfoBox.appendChild(distanceDiv);
			    }
			    
			 	// ì‚¬ìš©ìì™€ ë©”ì´íŠ¸ ê²½ë¡œ ì„  ê·¸ë¦¬ê¸°
			    const linePath = [
			        new kakao.maps.LatLng(userLat, userLng),
			        new kakao.maps.LatLng(mateLat, mateLng)
			    ];

			    const polyline = new kakao.maps.Polyline({
			        path: linePath,
			        strokeWeight: 3,
			        strokeColor: '#FF0000',
			        strokeOpacity: 0.8,
			        strokeStyle: 'solid'
			    });

			    polyline.setMap(map);
	          }
			 	
			    const infowindow = new kakao.maps.InfoWindow({
			        content:
			        	`<div style="
			                padding: 1px;
			                width: 170px;
			                font-size: 14px;
			                text-align: left;">
			                <b>${name}</b><br>${addr}</div>`,
			        zIndex: 1
			    });
			    infowindow.open(map, marker);
			});
			</script>
        </div>
        
        <div class="mate-info-box" th:if="${not #lists.isEmpty(findMate)}">
		    <h2>íŒŒí‚¹ ë©”ì´íŠ¸ ì •ë³´</h2>
		    <img src="/img/logo.png" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
		
		    <div th:each="mate : ${findMate}">
		        <div>ì´ë¦„: <span th:text="${mate['mate_name']}">ë©”ì´íŠ¸ ì´ë¦„</span></div>
		        <div>TEL: <span th:text="${mate['mate_tel']}">ë©”ì´íŠ¸ ì „í™”ë²ˆí˜¸</span></div>
    		</div>
		</div>
    </div>
</div>

<div style="height: 30px;"></div>
<th:block th:include = "@{/footer}"></th:block>
</body>
</html>