<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì•½ê´€ ë™ì˜</title>
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
  <style>
    .terms { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .terms-title { font-weight: bold; }
    .flex { display: flex; justify-content: space-between; align-items: center; }
    #payBtn { background-color: gray; color: white; padding: 10px; border: none; cursor: not-allowed; }
    #payBtn.active { background-color: blue; cursor: pointer; }
  </style>
</head>
<body>
  <h2>ì•½ê´€ ë™ì˜</h2>

  <div class="terms">
    <div class="flex">
      <span class="terms-title">[í•„ìˆ˜] ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ ë™ì˜</span>
      <label><input type="checkbox" class="agree" id="agree1"> ë™ì˜</label>
    </div>
  </div>

  <div class="terms">
    <div class="flex">
      <span class="terms-title">[í•„ìˆ˜] ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜</span>
      <label><input type="checkbox" class="agree" id="agree2"> ë™ì˜</label>
    </div>
  </div>

  <div class="terms">
    <div class="flex">
      <span class="terms-title">[í•„ìˆ˜] ìœ„ì¹˜ì •ë³´ ì´ìš©ì•½ê´€ ë™ì˜</span>
      <label><input type="checkbox" class="agree" id="agree3"> ë™ì˜</label>
    </div>
  </div>

  <div class="terms">
    <div class="flex">
      <span class="terms-title">[ì„ íƒ] ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜</span>
      <label><input type="checkbox" id="agree4"> ë™ì˜</label>
    </div>
  </div>

  <hr>

  <div style="margin-bottom:10px;">
    <label><input type="checkbox" id="checkAll"> ëª¨ë‘ ë™ì˜</label>
  </div>

  <div class="flex" style="border-top: 1px dashed #888; padding-top: 10px;">
    <div>ê²°ì œ ê¸ˆì•¡: <span id="finalPrice" th:text="${total}">0</span> ì›</div>
    <button id="payBtn" disabled>ê²°ì œí•˜ê¸°</button>
  </div>

  <script>
    const agreeChecks = document.querySelectorAll('.agree');
    const checkAll = document.getElementById('checkAll');
    const payBtn = document.getElementById('payBtn');

    // ëª¨ë‘ ë™ì˜
    checkAll.addEventListener('change', () => {
      agreeChecks.forEach(chk => chk.checked = checkAll.checked);
      togglePayButton();
    });

    // ê°ê° ì²´í¬ ë³€ê²½ ì‹œ
    agreeChecks.forEach(chk => {
      chk.addEventListener('change', () => {
        checkAll.checked = [...agreeChecks].every(c => c.checked);
        togglePayButton();
      });
    });

    // ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€ íŒë‹¨
    function togglePayButton() {
      const allChecked = [...agreeChecks].every(c => c.checked);
      if (allChecked) {
        payBtn.disabled = false;
        payBtn.classList.add("active");
      } else {
        payBtn.disabled = true;
        payBtn.classList.remove("active");
      }
    }

	// ê²°ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
	// === [â­ ê²°ì œ ë¡œì§] ===
	payBtn.addEventListener("click", () => {
	  const finalPrice = parseInt(document.getElementById('finalPrice').textContent.replace(/[^0-9]/g, '') || "0", 10);
	  const IMP = window.IMP;
	  IMP.init("imp84584038"); // ë³¸ì¸ imp í‚¤ë¡œ ëŒ€ì²´
	
	  IMP.request_pay({
	    pg: "kakaopay", 
	    pay_method: "card",
	    merchant_uid: "order_" + new Date().getTime(),
	    name: "ì£¼ì°¨ì¥ ì˜ˆì•½ ê²°ì œ",
	    amount: finalPrice,
	    buyer_email: "ì´ìˆ˜í•œ@naver.com",
	    buyer_name: "ì´ìˆ˜í•œ",
	    buyer_tel: "010-1234-5678",
	    buyer_addr: "ì„œìš¸íŠ¹ë³„ì‹œ",
	    buyer_postcode: "12345"
	  }, function (rsp) {
	    if (rsp.success) {
	        alert("ê²°ì œ ì„±ê³µ! imp_uid: " + rsp.imp_uid);
	        
	        // ğŸŸ¢ Ajaxë¡œ ì»¨íŠ¸ë¡¤ëŸ¬ì— ê²°ì œ ì„±ê³µ ì•Œë¦¬ê¸°
	        $.ajax({
	          url: "/payment",  // ì»¨íŠ¸ë¡¤ëŸ¬ì— POSTë¡œ ì „ì†¡
	          method: "POST",
	          success: function() {
	            location.href = "/";  // ì„±ê³µí•˜ë©´ indexë¡œ ì´ë™
	          },
	          error: function() {
	            alert("ê²°ì œ ì²˜ë¦¬ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!");
	          }
	        });

	      } else {
	        alert("ê²°ì œ ì‹¤íŒ¨: " + rsp.error_msg);
	      }
	    });
	  });
	</script>
</body>
</html>
