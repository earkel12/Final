<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ParkingMate 메인</title>
  <!-- ✅ 카카오 지도 SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=bef1fdbfb5b4d0c4519859a35fd0e1c4&autoload=false"></script>
</head>
<body>

<!-- 로그인 상태 확인 -->
<div th:if="${session.sname != null}">
  <p th:text="${session.sname} + '님 로그인 중'"></p> | <a href="logout">로그아웃</a>
</div>
<div th:if="${session.sname == null}">
  <a href="login">로그인</a>
</div>

<hr>

<!-- 내비게이션 -->
<a href="notice">공지사항</a><br>
<a href="register">회원가입</a><br>
<a href="parkingmate">파킹메이트</a><br>
<a href="community">커뮤니티</a><br>

<hr>

<!-- ✅ 지도 섹션 -->
<h2>주차장 지도</h2>
<div id="map" style="width:100%; height:600px;"></div>

<table border="1" style="margin-top:20px;" id="infoTable">
  <tr><th>이름</th><td id="name">-</td></tr>
  <tr><th>주소</th><td id="addr">-</td></tr>
  <tr><th>종류</th><td id="type">-</td></tr>
  <tr><th>요금</th><td id="price">-</td></tr>
  <tr><th>발렛</th><td id="valet">-</td></tr>
</table>
<a href="reser">예약하기</a><br>

<script>
  kakao.maps.load(function () {
    const mapContainer = document.getElementById('map');
    const mapOption = {
      center: new kakao.maps.LatLng(37.5665, 126.9780),
      level: 5
    };

    const map = new kakao.maps.Map(mapContainer, mapOption);
    const infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });

    // ✅ 주차장 목록 요청
    fetch('/map/list')
      .then(response => response.json())
      .then(data => {
        data.forEach(parking => {
          const position = new kakao.maps.LatLng(parking.latitude, parking.longitude);
          const marker = new kakao.maps.Marker({
            map: map,
            position: position,
            title: parking.name
          });

          kakao.maps.event.addListener(marker, 'click', function () {
            const content = `<div style="padding:5px;"><b>${parking.name}</b><br>${parking.addr}</div>`;
            infowindow.setContent(content);
            infowindow.open(map, marker);
            
            // 주차장 정보를 서버로 전달
            fetch(`/map/setSession?idx=${parking.idx}&name=${parking.name}&price=${parking.price}&price2=${parking.price2}`)
            .then(res => console.log("Session 저장 완료"));

            // 표 정보 업데이트
            document.getElementById('name').innerText = parking.name;
            document.getElementById('addr').innerText = parking.addr;
            document.getElementById('type').innerText = parking.type;
            document.getElementById('price').innerText = `${parking.price}원`;
            document.getElementById('valet').innerText = parking.valet === 1 ? '가능' : '불가능';
          });
        });
      })
      .catch(err => console.error(err));
  });
</script>

</body>
</html>