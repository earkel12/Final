<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pm.mapper.BookingMapper">
	<!-- mybatis설정 -->

	<insert id="insertBooking" parameterType="com.pm.booking.model.BookingDTO">
        INSERT INTO booking (bookingdate, bookingcarnum, intime, outtime, valet, instand, price, status, obstacle, idx, id, ulatitude, ulongitude)
        VALUES (#{bookingdate}, #{bookingcarnum}, #{intime}, #{outtime}, #{valet}, #{instand}, #{price}, #{status}, #{obstacle}, #{idx}, #{id}, #{ulatitude}, #{ulongitude})
    </insert>
	<select id="carbyid" parameterType="String" resultType="com.pm.booking.model.UserCarDTO">
		SELECT uc.car_num, uc.modelname
		FROM user_cars uc
		WHERE uc.id = #{id}
		AND NOT EXISTS (
		    SELECT 1
		    FROM booking b
		    WHERE b.bookingcarnum = uc.car_num
		    AND b.status != '전체결제완료'
		);

	</select>
	<update id="updateStatus" parameterType="String">
		UPDATE booking
		JOIN (
		SELECT bookingnum
		FROM (
		SELECT bookingnum
		FROM booking
		WHERE id = #{id}
		ORDER BY bookingnum DESC
		LIMIT 1
		) AS sub
		) AS sub2
		ON booking.bookingnum
		= sub2.bookingnum
		SET
		booking.status = '파킹메이트결제완료'
	</update>
	
	<select id="bookingCount" parameterType="Integer" resultType="Integer">
		select count(*) from booking where idx = #{idx}
	
	</select>
</mapper>