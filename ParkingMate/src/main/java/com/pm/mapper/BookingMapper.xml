<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pm.mapper.BookingMapper">
	<!-- mybatis설정 -->

	<insert id="insertBooking" parameterType="com.pm.booking.model.BookingDTO">
        INSERT INTO booking (bookingdate, bookingcarnum, intime, outtime, valet, instand, price, status, obstacle, idx, id)
        VALUES (#{bookingdate}, #{bookingcarnum}, #{intime}, #{outtime}, #{valet}, #{instand}, #{price}, #{status}, #{obstacle}, #{idx}, #{id})
    </insert>
	<select id="carbyid" parameterType="String" resultType="com.pm.booking.model.UserCarDTO">
		SELECT car_num, modelname from user_cars where id=#{id} 

	</select>
	<update id="updateStatus" parameterType="String">
		UPDATE booking
		JOIN (
		SELECT bookingnum
		FROM (
		SELECT bookingnum
		FROM booking
		WHERE id = #{id}
		ORDER BY bookingnum DESC
		LIMIT 1
		) AS sub
		) AS sub2
		ON booking.bookingnum
		= sub2.bookingnum
		SET
		booking.status = '파킹메이트결제완료';
	</update>
	
  <resultMap id="BookingParkingMap" type="com.pm.booking.model.BookingParkingDTO">
    <id property="bookingnum" column="bookingnum"/>
    <result property="bookingdate" column="bookingdate"/>
    <result property="bookingcarnum" column="bookingcarnum"/>
    <result property="intime" column="intime"/>
    <result property="outtime" column="outtime"/>
    <result property="valet" column="valet"/>
    <result property="instand" column="instand"/>
    <result property="price" column="price"/>
    <result property="status" column="status"/>
    <result property="obstacle" column="obstacle"/>

    <result property="lotIdx" column="lot_idx"/>
    <result property="lotName" column="name"/>
    <result property="lotAddr" column="addr"/>
    <result property="lotType" column="type"/>
    <result property="lotPrice" column="price"/>
  </resultMap>

  <select id="selectActiveInstadBookings" resultMap="BookingParkingMap">
    SELECT b.*, p.idx AS lot_idx, p.name, p.addr, p.type, p.price
      FROM booking b
      JOIN parkinglot p ON b.idx = p.idx
     WHERE b.instand = 1
       AND b.status = '예약접수'
     ORDER BY b.bookingdate DESC
  </select>
  <update id="updateStatusToReserved">
  UPDATE booking
  SET status = '예약중'
  WHERE bookingnum = #{bookingnum}
</update>
<select id="getBookingByNum" resultType="com.pm.booking.model.BookingDTO">
    SELECT * FROM booking WHERE bookingnum = #{bookingnum}
</select>
</mapper>